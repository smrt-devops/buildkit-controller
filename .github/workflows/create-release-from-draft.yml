name: Create Release from Draft

on:
  workflow_dispatch:
    inputs:
      pre_release_suffix:
        description: "Pre-release suffix (only used if not on main branch)"
        required: false
        type: choice
        options:
          - beta
          - alpha
          - rc
        default: beta

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create Release PR from Draft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get current branch
        id: branch
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Current branch: ${BRANCH}"

      - name: Get version from Release Drafter draft
        id: draft-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = '${{ steps.branch.outputs.branch }}' || 'main';

            // Get all releases (including drafts)
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Find draft releases
            const draftReleases = releases.filter(r => r.draft === true);

            let draftRelease;

            if (branch === 'main') {
              // For main branch, find draft without pre-release suffix
              draftRelease = draftReleases.find(r => 
                r.tag_name && !r.tag_name.includes('-beta') && !r.tag_name.includes('-alpha') && !r.tag_name.includes('-rc')
              );
              
              // Fallback to any draft if no stable draft found
              if (!draftRelease && draftReleases.length > 0) {
                draftRelease = draftReleases[0];
                console.log(`Warning: No stable draft found, using: ${draftRelease.tag_name}`);
              }
            } else {
              // For pre-release branches, prefer drafts with matching suffix
              // For now, just use the first draft (can be enhanced to match branch type)
              draftRelease = draftReleases[0];
            }

            if (!draftRelease || !draftRelease.tag_name) {
              core.setFailed(`No draft release found for branch '${branch}'. Ensure Release Drafter has created a draft release.`);
              return;
            }

            // Extract version from tag (remove 'v' prefix and any pre-release suffix)
            let version = draftRelease.tag_name.replace(/^v/, '');
            // Remove pre-release suffixes for base version
            version = version.replace(/-beta$/, '').replace(/-alpha$/, '').replace(/-rc$/, '');
            const body = draftRelease.body || '';

            core.setOutput('version', version);
            // Don't pass body through outputs to avoid template literal issues
            // The release workflow will fetch the draft release directly
            core.setOutput('tag_name', draftRelease.tag_name);

            console.log(`Branch: ${branch}`);
            console.log(`Found draft release: ${draftRelease.tag_name}`);
            console.log(`Base version: ${version}`);

      - name: Determine release type from branch
        id: release-type
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          PRE_RELEASE_SUFFIX="${{ inputs.pre_release_suffix }}"

          if [ "$BRANCH" = "main" ]; then
            RELEASE_TYPE="stable"
            echo "Branch is 'main', using stable release"
          else
            RELEASE_TYPE="$PRE_RELEASE_SUFFIX"
            echo "Branch is '${BRANCH}', using ${RELEASE_TYPE} pre-release"
          fi

          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

      - name: Adjust version for pre-release
        id: final-version
        run: |
          VERSION="${{ steps.draft-release.outputs.version }}"
          RELEASE_TYPE="${{ steps.release-type.outputs.release_type }}"

          # If stable release, use version as-is
          if [ "$RELEASE_TYPE" = "stable" ]; then
            FINAL_VERSION="$VERSION"
          else
            # Check if version already has a pre-release suffix
            if [[ "$VERSION" =~ -(alpha|beta|rc)\. ]]; then
              BASE_VERSION=$(echo "$VERSION" | sed -E 's/-(alpha|beta|rc)\.[0-9]+$//')
              PRE_RELEASE_NUM=$(echo "$VERSION" | sed -E 's/.*-(alpha|beta|rc)\.([0-9]+)$/\2/')
              PRE_RELEASE_TYPE=$(echo "$VERSION" | sed -E 's/.*-((alpha|beta|rc))\.[0-9]+$/\1/')
              
              # If same pre-release type, increment; otherwise start at 1
              if [ "$PRE_RELEASE_TYPE" = "$RELEASE_TYPE" ]; then
                PRE_RELEASE_NUM=$((PRE_RELEASE_NUM + 1))
                FINAL_VERSION="${BASE_VERSION}-${RELEASE_TYPE}.${PRE_RELEASE_NUM}"
              else
                FINAL_VERSION="${BASE_VERSION}-${RELEASE_TYPE}.1"
              fi
            else
              # Add pre-release suffix
              FINAL_VERSION="${VERSION}-${RELEASE_TYPE}.1"
            fi
          fi

          echo "version=${FINAL_VERSION}" >> $GITHUB_OUTPUT
          echo "Final version: ${FINAL_VERSION}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.final-version.outputs.version }}"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            exit 1
          fi

          echo "‚úÖ Version format is valid: $VERSION"

      - name: Check if tag exists
        run: |
          TAG="v${{ steps.final-version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG already exists!"
            exit 1
          fi

      - name: Create release branch
        run: |
          BRANCH_NAME="release/v${{ steps.final-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          echo "branch=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Update Chart.yaml version
        run: |
          CHART_FILE="helm/buildkit-controller/Chart.yaml"
          if [ -f "$CHART_FILE" ]; then
            VERSION="${{ steps.final-version.outputs.version }}"
            sed -i.bak "s/^version:.*/version: ${VERSION}/" "$CHART_FILE"
            sed -i.bak "s/^appVersion:.*/appVersion: \"${VERSION}\"/" "$CHART_FILE"
            rm -f "${CHART_FILE}.bak"
            git add "$CHART_FILE"
            git commit -m "chore: update Chart.yaml to version ${VERSION}" || true
          fi

      - name: Push branch
        run: |
          git push origin "${{ env.branch }}"

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.final-version.outputs.version }}';
            const releaseType = '${{ steps.release-type.outputs.release_type }}';
            const tag = `v${version}`;
            const branch = '${{ env.branch }}';
            const sourceBranch = '${{ steps.branch.outputs.branch }}';
            const isPrerelease = releaseType !== 'stable';
            const prereleaseEmoji = isPrerelease ? '‚ö†Ô∏è' : 'üéâ';
            const prereleaseText = isPrerelease ? 'Pre-release' : 'Stable Release';

            const body = `## ${prereleaseEmoji} Release ${prereleaseText}: v${version}

            This PR prepares the release of version \`v${version}\` based on the Release Drafter draft.

            ### Release Information
            - **Version**: \`v${version}\`
            - **Type**: ${prereleaseText}
            - **Tag**: \`${tag}\`
            - **Source Branch**: \`${sourceBranch}\`
            ${isPrerelease ? `- **Pre-release Type**: ${releaseType}` : ''}

            ### Release Notes

            Release notes will be generated from the Release Drafter draft when this PR is merged.

            ### What happens when this PR is merged?

            1. ‚úÖ Tag \`${tag}\` will be created automatically
            2. üê≥ Docker images will be built and pushed
            3. üì¶ Helm chart will be published
            4. üìù GitHub release will be created with the draft release notes

            ---

            **Note**: This PR was created automatically from the Release Drafter draft.
            `;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release v${version}`,
              head: branch,
              base: 'main',
              body: body
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['release', releaseType]
            });

            return pr.data.number;

      - name: Output PR URL
        run: |
          echo "‚úÖ Release PR created: #${{ steps.create-pr.outputs.result }}"
          echo "PR URL: https://github.com/${{ github.repository }}/pull/${{ steps.create-pr.outputs.result }}"
